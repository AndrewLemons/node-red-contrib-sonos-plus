<!-- Sonos My Sonos Node -->

<!-- Registering Node (JavaScript) -->
<script type="text/javascript">
  /* global  RED */
  /* eslint no-undef: "error" */
  RED.nodes.registerType('sonos-manage-mysonos', {
    category: 'SonosPlus',
    defaults: {
      confignode: {
        value: '',
        type: 'sonos-config'
      },
      command: { value: 'message' },
      compatibilityMode: { value: false },
      name: {value: ''}
    },
    inputs: 1, // set the number of inputs - only 0 or 1
    outputs: 1, // set the number of outputs - 0 to n
    icon: 'sonos.png', // saved in  icons/myicon.png
    color: '#95c292',
    label: function() {
      let found = mySonosCmdList.find(item => item.cmd === this.command);
      // mark all nodes with depreciated compatibility mode
      let nodeLabel = this.name || found.cmd || "My Sonos"
      nodeLabel = (this.compatibilityMode ? '!! ' : '') + nodeLabel
      return nodeLabel;
    },
    oneditprepare: function() {             
      for (var i = 0; i < mySonosCmdList.length; i++) {
       $('#node-input-command').append($("<option></option>").attr("value", mySonosCmdList[i].cmd).text(mySonosCmdList[i].text));
      }
         
      // select command
      $('#node-input-command').val(this.command);
    },
    paletteLabel: 'My Sonos'
  });
</script>

<!-- Setting design and inputs for node panel (HTML)-->
<script type="text/x-red" data-template-name="sonos-manage-mysonos">
  <div id="main-props">
    <!-- Config node -->
    <div class="form-row">
      <label for="node-input-confignode"> Config Node</label>
      <input type="text" id="node-input-confignode"/>
    </div>
    <!-- Compatibility mode -->
    <div class="form-row">
      <label for="node-input-compatibilityMode"> Compatibility</label>
      <input type="checkbox" id="node-input-compatibilityMode" style="display: inline-block; width: auto; vertical-align: top;"/>
    </div>
    <!-- Command selection -->
    <div class="form-row">
      <label for="node-input-command"> Command</label>
      <select id="node-input-command">
      </select>
    </div>
    <!-- Node name -->
    <div class="form-row">
      <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
      <input type="text" id="node-input-name" placeholder="This node name"/>
    </div>
    
    <!-- Dialog help -->
    <div class="text">        
      <b>Config Node</b> provides the default SONOS player.<br><br>
    
      The new standard/default for using the input message is: 
      <ul>
        <li><code>msg.topic</code> holds the command</li>
        <li><code>msg.payload</code> holds the "state/message" like on/off, uri, ...</li>
      </ul>
      It is recommended to use this <b>default mode!</b><br><br>

      Tic <b>Compatibility</b> to get the old style:
      <ul>
        <li><code>msg.payload</code> holds the command</li>
        <li><code>msg.topic</code> holds the "state/message" like on/off, uri, ...</li>
      </ul>
      <b>Command</b> provides a pick up list of all available commmands<br>
      and "using msg".
    </div>
  </div>
</script>

<script type="text/javascript">
  // mySonosCmdList has to be kept in sync with the table in .js file! First item is message! 
  // TODO find a comman base for mySonosCmdList and COMMAND_TABLE_MYSONOS
  // We need two properties for <select>
  // Message first, all others in lexi order, ascending
    const mySonosCmdList = [
    {cmd: "message", text: "using msg"},
    {cmd: "mysonos.export.item", text: "My Sonos: export the specified item"},
    {cmd: "mysonos.get.items", text: "My Sonos: get all items"},
    {cmd: "mysonos.queue.item", text: "My Sonos: queue the specified item"},
    {cmd: "mysonos.stream.item", text: "My Sonos: stream the specified item"},
    {cmd: "library.export.playlist", text: "Library: export the specified playlist"},
    {cmd: "library.queue.playlist", text: "Library: queue the specified playlist"},
    {cmd: "library.get.playlists", text: "Library: get all playlists"}
    ];
</script>

<!-- Help text (HTML) -->
<script type="text/x-red" data-help-name="sonos-manage-mysonos">
<p>This node provides all commands related to My Sonos and the Music Library. Default is My Sonos.<p>
<br>

<h1>Input</h1>

Each command has specific input and output properties.
Details: <a href="https://github.com/hklages/node-red-contrib-sonos-plus/wiki/A400.2-My-Sonos-Node">here.</a>
<br>

The most important properties are: 

<dl class="message-properties">

  <dt>payload <span class="property-type">depend on command</span></dt>
  <dd>The case sensitive new state/message like on/off, uri, .... </dd>

  <dt class="required">topic <span class="property-type">string</span></dt>
  <dd>The command like group.play, group.play.queue, ...</dd>

</dl>
<br>

<h1>Outputs</h1>

The incoming command (msg.topic) is converted to the full command name in lowercase. Furthermore all "get/export" commands outputs to msg.payload.
Details: <a href="https://github.com/hklages/node-red-contrib-sonos-plus/wiki/A400.2-My-Sonos-Node">here.</a>

<dl class="message-properties">
    <dt>payload <span class="property-type">depend on command</span> </dt>
    <dd>In case of <b>get/export</b> the requested data is being provided. </dd>
</dl>
<br>

<h1>Available Commands</h3>

See the node dialog (field command) and details <a href="https://github.com/hklages/node-red-contrib-sonos-plus/wiki/A400.2-My-Sonos-Node">here.</a>
  
</script>
