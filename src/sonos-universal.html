<!-- Sonos Universal Node -->

<!-- Registering Node (JavaScript) -->
<script type="text/javascript">
  /* global  RED */
  /* eslint no-undef: "error" */
  RED.nodes.registerType('sonos-universal', {
    category: 'SonosPlus',
    defaults: {
      confignode: {
        value: '',
        type: 'sonos-config'
      },
      command: { value: 'message' },
      playerName: { value: '' },
      compatibilityMode: { value: false },
      name: { value: '' }, 
    },
    inputs: 1, // set the number of inputs - only 0 or 1
    outputs: 1, // set the number of outputs - 0 to n
    icon: 'sonos.png', // saved in  icons/myicon.png
    color: '#AAAAAA',
    label: function() {
      let found = cmdList.find(item => item.cmd === this.command);
      return this.name || found.name || "Universal";
    },
    oneditprepare: function() {             
      for (var i = 0; i < cmdList.length; i++) {
       $('#node-input-command').append($("<option></option>").attr("value", cmdList[i].cmd).text(cmdList[i].name));
      }
         
      // Make sure the selected value is also selected in the <select> tag
      $('#node-input-command').val(this.command);
    }, 
    paletteLabel: 'Universal'
  });
</script>

<!-- Setting design and inputs for node panel (HTML)-->
<script type="text/x-red" data-template-name="sonos-universal">
  <div id="main-props">
    <div class="form-row">
      <label for="node-input-confignode"> Config Node</label>
      <input type="text" id="node-input-confignode"/>
    </div>
    <!-- Compatibility mode style-->
    <div class="form-row">
      <label for="node-input-compatibilityMode"> Compatibility</label>
      <input type="checkbox" id="node-input-compatibilityMode" style="display: inline-block; width: auto; vertical-align: top;"/>
    </div>
    <!-- Command selection -->
    <div class="form-row">
      <label for="node-input-command"> Command</label>
      <select id="node-input-command">
      </select>
    </div>
    <!-- node name-->
    <div class="form-row">
      <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
      <input type="text" id="node-input-name" placeholder="This node name"/>
    </div>
    
    <!-- Explanation-->
    <div class="text">
            
      <b>Config Node</b> provides the default SONOS player.<br>
      <code>msg.playerName</code> - if exists - overrides that player.<br><br>
    
      The new standard for using the input message is: 
      <ul>
        <li><code>msg.cmd</code> holds the command</li>
        <li><code>msg.payload</code> holds additional parameter like on/off, uri, ...</li>
      </ul>
      Tic <b>Compatibility</b> to get the old style:
      <ul>
        <li><code>msg.payload</code> holds the command</li>
        <li><code>msg.topic</code> holds additional parameter like on/off, uri, ...</li>
      </ul>
      <b>Command</b> provides a pick up list of all available commmands<br>
      and "using msg".
     </div>
  </div>
</script>

<script type="text/javascript">
// cmdList has to be kept in sync with the java file! First item is message! 
// TODO find a comman base for cmdList and COMMAND_TABLE_UNIVERSAL
// We need two properties for <select>
// message first, all others in lexi order, ascending
  const cmdList = [
  {cmd: "message", name: "using msg"},
    {cmd: "group.adjust.volume", name: "group: adjust volume"},
    {cmd: "group.clear.queue", name: "group: clear queue"},
    {cmd: "group.create.snap", name: "group: create snapshot"},
    {cmd: "group.get.crossfade", name: "group: get crossfade mode"},
    {cmd: "group.get.mutestate", name: "group: get mute state"},
    {cmd: "group.get.playbackstate", name: "group: get playback state"},
    {cmd: "group.get.queue", name: "group: get queue"},
    {cmd: "group.get.sleeptimer", name: "group: get sleeptimer"},
    {cmd: "group.get.state", name: "group: get state"},
    {cmd: "group.get.trackplus", name: "group: get track plus more data"},
    {cmd: "group.get.volume", name: "group: get volume"},
    {cmd: "group.next.track", name: "group: next track"},
    {cmd: "group.pause", name: "group: pause"},
    {cmd: "group.play", name: "group: play"},
    {cmd: "group.play.export", name: "group: play exported item"},
    {cmd: "group.play.notification", name: "group: play notification"},
    {cmd: "group.play.queue", name: "group: play queue"},
    {cmd: "group.play.snap", name: "group: play snapshot"},
    {cmd: "group.play.streamhttp", name: "group: play stream with http"},
    {cmd: "group.play.track", name: "group: play track in queue"},
    {cmd: "group.play.tunein", name: "group: play tunein"},
    {cmd: "group.previous.track", name: "group: previous track"},
    {cmd: "group.remove.tracks", name: "group: remove tracks"},
    {cmd: "group.save.queue", name: "group: save queue to Sonos playlists"},
    {cmd: "group.seek", name: "group: seek in current track"},
    {cmd: "group.set.crossfade", name: "group: set crossfade mode"},
    {cmd: "group.set.mutestate", name: "group: set mute state"},
    {cmd: "group.set.queuemode", name: "group: set queue mode"},
    {cmd: "group.set.sleeptimer", name: "group: set sleeptimer"},
    {cmd: "group.stop", name: "group: stop"},
    {cmd: "group.toggle.playback", name: "group: toggle playback"},
    {cmd: "household.create.stereopair", name: "household: create stereopair"},
    {cmd: "household.get.groups", name:" household: get all groups"},
    {cmd: "household.remove.sonosplaylist", name: "household: remove SONOS playlist"},
    {cmd: "household.separate.stereopair", name: "household: separate stereopair"},
    {cmd: "household.test.player", name:"household: test player"},
    {cmd: "joiner.play.notification", name: "joiner: play notification"},
    {cmd: "player.adjust.volume", name: "player: adjust volume"},
    {cmd: "player.get.dialoglevel", name:  "player: get speech enhancement"},
    {cmd: "player.get.led", name:  "player:  get led state"},
    {cmd: "player.get.loudness", name:  "player: get loudness state"},
    {cmd: "player.get.mutestate", name:  "player: get mute state"},
    {cmd: "player.get.nightmode", name:  "player: get nightmode"},
    {cmd: "player.get.properties", name:  "player: get properties"},
    {cmd: "player.get.queue", name:  "player: get queue"},
    {cmd: "player.get.role", name:  "player: get role"},
    {cmd: "player.get.subgain", name:  "player: get subgain"},
    {cmd: "player.get.volume", name:  "player: get volume"},
    {cmd: "player.join.group", name:  "player: join group"},
    {cmd: "player.leave.group", name:  "player: leave group"},
    {cmd: "player.play.avtransport", name:  "player: play avtransport"},
    {cmd: "player.set.dialoglevel", name:  "player: speech enhancement"},
    {cmd: "player.set.led", name:  "player: set led state"},
    {cmd: "player.set.loudness", name:  "player: set loudness"},
    {cmd: "player.set.mutestate", name:  "player: set mute state"},
    {cmd: "player.set.nightmode", name:  "player: set nightmode"},
    {cmd: "player.set.subgain", name:  "player: set.subgain"},
    {cmd: "player.set.volume", name:  "player: set volume"}
];
</script>

<!-- Help text (HTML) -->
<script type="text/x-red" data-help-name="sonos-universal">
<p>Incoming message is a command and acts on the whole <b>GROUP</b>!
Only if explicitly stated (command prefix: joiner, player) the message acts on the given player.<p>

The group is identified by the given player. <b>msg.playerName</b> overrides the configuration node player. 
The <b>msg.playerName</b> is the name of the SONOS player (aka room, zone) and NOT the name of a configuration node!</br>

<b>Joiner</b> is the "opposite" of <b>coordinator</b>. A group always consist of a unique coordinator and optional joiners.</br>
<br>
Only <b>get.*, create.snap</b> modify the incoming message.</b>

<h1>Input (msg properties before processing)</h3>

<dl class="message-properties">

  <dt>payload (always required) <span class="property-type">string</span></dt>
  <dd>A command. Valid commands see section Commands.</dd>

  <dt class="optional">topic (some commands)<span class="property-type">string</span></dt>
  <dd>Additonal parameter for the given command.</dd>

  <dt class="optional">playerName <span class="property-type">string</span></dt>
  <dd>SONOS Player name aka room name aka zone (priority) If missing, the one given in configuration is used. </dd>

  <dt class="optional">volume (some commands) <span class="property-type">string/number</span></dt>
  <dd>Volume as integer in range 1 .. 99</dd>

  <dt class="optional">sameVolume (some commands) <span class="property-type">boolean</span></dt>
  <dd>All player in group will play at the specified volume - default is true!</dd>

  <dt class="optional">duration (only play.notification, joiner.play.notification) <span class="property-type">string</span></dt>
  <dd>The duration of the notification in format hh:mm:ss - if left, program will try to calculate the best duration </dd>

  <dt>export (only play.export) <span class="property-type">object</span></dt>
  <dd>The uri (string), metadata(string) and queue identifier (boolean) of the content to be played.</dd>

  <dt class="optional">snapVolumes (only create.snap) <span class="property-type">boolean</span></dt>
  <dd>If true the volume level of group members is captured. Default is false</dd>

  <dt class="optional">snapMutestates (only create.snap) <span class="property-type">boolean</span></dt>
  <dd>If true the mute state of group members is captured. Default is false</dd>

  <dt>snap (only play.snap) <span class="property-type">object</span></dt>
  <dd>snap holds wasPlaying, playbackstate, CurrentURI, CurrentURIMetadata, NrTracks, Track, RelTime, TrackDuration</dd>

  <dt class="optional">clearQueue (only play.export) <span class="property-type">boolean</span></dt>
  <dd>The queue is first cleared, then the exported items are imported. </dd>

  <dt class="optional">ignoreNotExists (remove.sonosplaylist) <span class="property-type">boolean</span></dt>
  <dd>If the playlist is not found The uri (string), metadata(string) and queue(boolean) identifier of the content to be played.</dd>

  <dt class="optional">numberOfTracks (remove.tracks) <span class="property-type">string/number</span></dt>
  <dd>number of tracks to be removed as integer in range 1 .. </dd>

</dl>

<h1>Output (msg properties after processing)</h3>

<dl class="message-properties">
    <dt>payload <span class="property-type">string</span> </dt>
    <dd>In case of <b>get</b> the requested data is provided. </dd>
</dl>

<dl class="message-properties">
  <dt>snap <span class="property-type">object</span> </dt>
  <dd>In case of <b>create.snap</b> the snapshot data. </dd>
</dl>

<h1>Commands</h3>

In general the commands are "GROUP" oriented and only those commands with prefix "player", "joiner" address a specific player.

<ul>
  <li>
    <code>play</code> Continues playing in the group.<br>
    Optional properties: playerName (overrides config node player), volume, sameVolume
  </li>
  <li>
    <code>play.queue</code> Activates and starts playing the SONOS queue. Queue must not be empty<br>
    Optional properties: playerName (overrides config node player), volume, sameVolume 
  </li>
  <li>
    <code>play.track</code> Activates and starts playing the SONOS queue with a specific track. Queue must not be empty<br>
    Required property: topic: tracknumber 1 .. lenght of queue<br>
    Optional properties: playerName (overrides config node player), volume, sameVolume 
  </li>
  <li>
    <code>play.export</code> Starts playing content (eg an item from My Sonos, command get.item) in the group. <br>
    Required properties: export.uri, export.queue<br>
    Optional properties: playerName (overrides config node player), volume, sameVolume, clearQueue: default true, export.metadata
  </li>
  <li>
    <code>play.tunein</code> Starts playing the TuneIn radio station<br>
    Required property:  topic: TuneIn radio id<br>
    Optional properties: playerName (overrides config node player), volume, sameVolume
  </li>
  <li>
    <code>play.streamhttp</code> Starts playing a http stream from internet<br>
    Required property: topic: http/https stream id<br>
    Optional properties: playerName (overrides config node player), volume, sameVolume
  </li>
  <li>
    <code>play.notification</code> Sends a notification to a group. If volume is specified, all will play at the specified volume.<br>
    Required property: topic: notification uri<br>
    Optional properties: playerName (overrides config node player), volume, sameVolume, duration
  </li>
  <li>
    <code>joiner.play.notification</code> Sends a notification to joiner that means a member not beeing the coordinator<br>
    Required property: topic: notification uri<br>
    Optional properties: playerName (overrides config node player), volume, duration
  </li>
  <li>
    <code>play.snap</code> Plays a given snapshot.<br>
    Required property: snap: snapshot data<br>
    Optional properties: playerName (overrides config node player)
  </li>
  <li>
    <code>toggle.playback</code> Toggles playback in the group (playing, paused)<br>
    Optional properties are: playerName (overrides config node player)
  </li>
  <li>
    <code>pause</code> Pause playing in the group.<br>
    Optional properties: playerName (overrides config node player)
  </li>
  <li>
    <code>stop</code> Stops playing in the group.<br>
    Optional properties are: playerName (overrides config node player)
  </li>
  <li>
    <code>next.track</code> Skips to next track (if supported by current stream).<br>
    Optional properties: playerName (overrides config node player)    
  </li>
  <li>
    <code>previous.track</code> Skips back track (if supported by current stream).<br>
    Optional property: playerName (overrides config node player)    
  </li>
  <li>
    <code>adjust.volume</code> Adjusts the group volume.<br> 
    Required property: topic is the volume
    Optional properties: playerName (overrides config node player)
  </li>
  <li>
    <code>player.adjust.volume</code> Adjusts the volume of the specified player.<br>
    Required property: topic is the volume
    Optional properties: playerName (overrides config node player)  
  </li>
  <li>
    <code>player.set.volume</code> Sets the volume of the specified player.<br> 
    Required property: topic is the new volume 1 .. 99<bf>
    Optional properties: playerName, volume. volume overrides topic.
  </li>
  <li>
    <code>set.mutestate</code> Sets the group mute state.<br>
    required property: topic specifies the state On, Off<br>
    Optional properties are: playerName (overrides config node player) 
  </li>
  <li>
    <code>player.set.mutestate</code> Sets the mute state of the specified player.<br>
    required property: topic specifies the state On, Off<br>
    Optional properties are: playerName (overrides config node player)  
  </li>
  <li>
    <code>set.queuemode</code> Sets the group queue mode<br>
    required property: topic: normal shuffle repeat_one repeat_all shuffle_norepeat shuffle_repeat_one<br>
    Optional properties are: playerName (overrides config node player)  
  </li>
  <li>
    <code>seek</code> Sets the group position in current track if supported<br>
    required property: topic: time in format hh:mm:ss<br>
    Optional properties are: playerName (overrides config node player)  
  </li>
  <li>
    <code>set.sleeptimer</code> Sets the group sleep timer<br>
    required property: topic: time in format hh:mm:ss<br>
    Optional properties are: playerName (overrides config node player)  
  </li>
  <li>
    <code>set.crossfade</code> Sets the group crossfade if supported<br>
    required property: topic: On or Off<br>
    Optional properties are: playerName (overrides config node player)  
  </li>
  <li>
    <code>create.snap</code> Creates a snapshot<br>
    Optional properties are: playerName (overrides config node player), snapMutestate, snapVolumes
  </li>
  <li>
    <code>save.queue</code> Saves the current queue to a Sonos playlist.<br>
    Required property: topic - title of Sonos playlist<br>
    Optional properties: playerName (overrides config node player)  
  </li>
  <li>
    <code>clear.queue</code> Clears the SONOS queue.<br>
    Optional properties: playerName (overrides config node player)  
  </li>
  <li>
    <code>remove.tracks</code> Removes/deletes tracks from group queue<br>
    Required property: topic: the start track<br>
    Optional properties: playerName (overrides config node player), numberOfTracks 1 .. 
  </li>
  <li>
    <code>remove.sonosplaylist</code> Removes/deletes the given Sonos playlist.<br>
    Required property: topic - the playlist title
    Optional properties: playerName (overrides config node player), ignoreNotExist
  </li>
  <li>
    <code>player.join.group</code> The given player joins the group, specified in topic<br>
    Required property : topic: name of any player in target group<br>
    Optional property: playerName (overrides config node player)
  </li>
  <li>
    <code>player.leave.group</code> The given player will leave the group = standalone<br>
    Optional property: playerName (overrides config node player)
  </li>
  <li>
    <code>household.get.groups</code> Outputs all groups and all members. First member is coordinator<br>
    Optional property: playerName (overrides config node player)
  </li>
  <li>
    <code>get.state</code> Outputs the current playback state, queue status, queue mode, coordinator name, mute state<br>
    Optional property: playerName (overrides config node player)
  </li>
  <li>
    <code>get.playbackstate</code> Outputs the current playback state in the group.<br>
    Optional property: playerName (overrides config node player)
  </li>
  <li>
    <code>get.volume</code> Outputs the group volume.<br> 
    Optional property: playerName (overrides config node player)
  </li>
  <li>
    <code>player.get.volume</code> Outputs the volume.<br> 
    Optional property: playerName (overrides config node player)  
  </li>
  <li>
    <code>get.mutestate</code> Outputs the group mute state.<br> 
    Optional properties are: playerName (overrides config node player)  
  </li>
  <li>
    <code>player.get.mutestate</code> Outputs the mute state of the specified player<br> 
    Optional property: playerName (overrides config node player)
  </li>
  <li>
    <code>get.crossfade</code> Outputs the group crossfade mode.<br> 
    Optional properties are: playerName (overrides config node player)  
  </li>
  <li>
    <code>get.sleeptimer</code> Outputs the group remaining sleeptimer.<br> 
    Optional properties are: playerName (overrides config node player)  
  </li>
  <li>
    <code>player.get.role</code> Outputs the current state: coordinator|joiner|independent and the SONOS player name.<br>
    Optional properties are: playerName (overrides config node player)
  </li>
  <li>
    <code>get.queue</code> Outputs the current queue.<br>
    Optional properties are: playerName (overrides config node player)
  </li>
  <li>
    <code>player.get.queue</code> Outputs the current queue of the specified player.<br>
    Optional property: playerName (overrides config node player)
  </li>
  <li>
    <code>get.trackplus</code> Outputs the track, media and position data - also status of queue, title,artist, TuneIn radio id<br>
    Optional property: playerName (overrides config node player)
  </li>
</ul>
</script>
